// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  stackUserId   String   @unique
  email         String
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([stackUserId])
}

model Board {
  id          Int      @id
  name        String
  type        String   // "MS" or "PS"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets     Ticket[]

  @@index([type])
}

model Member {
  id              Int      @id
  identifier      String   @unique
  firstName       String?
  lastName        String?
  email           String?
  inactiveFlag    Boolean  @default(false)
  isActive        Boolean  @default(true) // Helper based on dates
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  timeEntries     TimeEntry[]
  reviews         Review[]

  @@index([identifier])
  @@index([inactiveFlag])
}

// Service board tracking - which boards are for service desk vs projects
model ServiceBoard {
  id          Int      @id
  boardId     Int      @unique
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([boardId])
}

model Ticket {
  id              Int      @id
  summary         String?
  boardId         Int
  status          String?
  closedDate      DateTime?
  closedFlag      Boolean  @default(false)
  dateEntered     DateTime?
  resolvedDate    DateTime?
  // Extended fields for service desk
  owner           String?   // Owner identifier
  company         String?   // Company name
  type            String?   // Ticket type
  priority        String?   // Priority level
  subtype         String?   // Ticket subtype (e.g., "Software", "Hardware")
  item            String?   // Ticket item (e.g., "Excel", "Mouse")
  initialDescription String? // The "Problem" description (truncated to 2000 chars)
  resources       String?   // Comma-separated resource identifiers
  estimatedHours  Float?
  actualHours     Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  board           Board        @relation(fields: [boardId], references: [id])
  timeEntries     TimeEntry[]

  @@index([boardId])
  @@index([closedFlag])
  @@index([dateEntered])
  @@index([resolvedDate])
  @@index([owner])
  @@index([company])
}

model TimeEntry {
  id              Int      @id
  memberId        Int
  ticketId        Int?
  projectId       Int?     // Link to project if applicable
  hours           Float
  billableOption  String?  // "Billable", "DoNotBill", "NoCharge", etc.
  notes           String?
  dateStart       DateTime
  dateEnd         DateTime?
  internalNotes   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  member          Member      @relation(fields: [memberId], references: [id])
  ticket          Ticket?     @relation(fields: [ticketId], references: [id])
  project         Project?    @relation(fields: [projectId], references: [id])

  @@index([memberId])
  @@index([ticketId])
  @@index([projectId])
  @@index([dateStart])
  @@index([billableOption])
}

model Project {
  id                  Int       @id
  name                String
  status              String?   // "Open", "Closed", etc.
  company             String?   // Company name
  managerIdentifier   String?   // Manager identifier (e.g., "DSolomon")
  managerName         String?   // Manager full name
  boardName           String?
  estimatedStart      DateTime?
  estimatedEnd        DateTime?
  actualStart         DateTime?
  actualEnd           DateTime?
  estimatedHours      Float?
  actualHours         Float?
  percentComplete     Float?
  type                String?
  closedFlag          Boolean   @default(false)
  description         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  timeEntries         TimeEntry[]
  projectTickets      ProjectTicket[]

  audits              ProjectAudit[]

  @@index([status])
  @@index([managerIdentifier])
  @@index([closedFlag])
  @@index([company])
}

model ProjectAudit {
  id              String    @id @default(cuid())
  projectId       Int
  status          String?   // The status changed TO
  previousStatus  String?   // The status changed FROM
  changedBy       String?   // User identifier who made the change
  dateEntered     DateTime
  message         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project         Project   @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([dateEntered])
}

model ProjectTicket {
  id              Int       @id
  summary         String?
  projectId       Int
  projectName     String?
  phaseId         Int?
  phaseName       String?
  boardId         Int?
  boardName       String?
  status          String?
  company         String?
  resources       String?   // Comma-separated resource identifiers
  closedFlag      Boolean   @default(false)
  priority        String?
  type            String?
  wbsCode         String?
  budgetHours     Float?
  actualHours     Float?
  subtype         String?   // Ticket subtype
  item            String?   // Ticket item
  initialDescription String? // The "Problem" description
  dateEntered     DateTime?

  closedDate      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project         Project   @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([closedFlag])
  @@index([dateEntered])
}

model SyncLog {
  id                String   @id @default(cuid())
  entityType        String   @unique // "members", "boards", "tickets", "timeEntries", "projects", "projectTickets"
  lastSyncAt        DateTime
  recordCount       Int      @default(0)
  cachedRecordCount Int      @default(0)  // Number of records served from cache
  freshRecordCount  Int      @default(0)  // Number of records fetched fresh from API
  cacheHitRate      Float?                // Percentage of records served from cache
  status            String   @default("success") // "success", "failed", "in_progress"
  errorMessage      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([entityType])
  @@index([lastSyncAt])
}

model EntityCache {
  id             String   @id @default(cuid())
  entityType     String   // "board", "member", "serviceBoard"
  entityId       Int      // The ID of the cached entity
  lastFetchedAt  DateTime // When this entity was last fetched from ConnectWise API
  expiresAt      DateTime // When this cache entry expires
  metadata       Json?    // Additional metadata about the entity
  checksum       String?  // Hash of the entity data for change detection
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([expiresAt])
  @@index([lastFetchedAt])
}

model AnalysisCache {
  id              String   @id @default(cuid())
  cacheKey        String   @unique
  cacheType       String   // "trend", "comparison", "review"
  data            Json
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cacheKey])
  @@index([cacheType])
  @@index([expiresAt])
}

model Review {
  id              String   @id @default(cuid())
  memberId        Int
  reviewType      String   // "msp_standards", "quarterly", "annual"
  periodStart     DateTime
  periodEnd       DateTime
  summary         String
  details         Json
  score           Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  member          Member   @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([reviewType])
  @@index([periodStart, periodEnd])
}

